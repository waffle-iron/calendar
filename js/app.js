define(["components/react","components/react-dom","components/lodash","components/moment","components/jsspeechrecognizer","components/chrono"],function(e,t,n,i,o,r){"use strict";e="default"in e?e["default"]:e,t="default"in t?t["default"]:t,n="default"in n?n["default"]:n,i="default"in i?i["default"]:i,o="default"in o?o["default"]:o,r="default"in r?r["default"]:r;var s=function(){var e="function"==typeof Symbol&&Symbol["for"]&&Symbol["for"]("react.element")||60103;return function(t,n,i,o){var r=t&&t.defaultProps,s=arguments.length-3;if(n||0===s||(n={}),n&&r)for(var a in r)void 0===n[a]&&(n[a]=r[a]);else n||(n=r||{});if(1===s)n.children=o;else if(s>1){for(var c=Array(s),l=0;l<s;l++)c[l]=arguments[l+3];n.children=c}return{$$typeof:e,type:t,key:void 0===i?null:""+i,ref:null,props:n,_owner:null}}}(),a=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},c=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),l=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},u=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},h=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},p=function(){function e(t){a(this,e),Object.assign(this,t||{})}return e.prototype.main=function(){throw new Error("Not implemented!")},e}(),g=function(e){function t(n){a(this,t);var i=u(this,e.call(this,n));return i.state={login:"mozilla"},i.server=n.server,i.onChange=i.onChange.bind(i),i.onFormSubmit=i.onFormSubmit.bind(i),i}return l(t,e),t.prototype.onChange=function(e){var t=e.target.value;this.setState({login:t})},t.prototype.onFormSubmit=function(e){e.preventDefault(),this.server.login(this.state.login,"password").then(function(){location.hash="reminders"})},t.prototype.render=function(){return s("form",{className:"user-login",onSubmit:this.onFormSubmit},void 0,s("input",{value:this.state.login,placeholder:"Family name",className:"user-login__name-field",onChange:this.onChange}),s("button",{className:"user-login__login-button"},void 0,s("img",{src:"css/icons/next.svg"})))},t}(e.Component),d=["login","logout"],f=d[0],m=function(n){function i(){return a(this,i),u(this,n.apply(this,arguments))}return l(i,n),i.prototype.main=function(){var e=arguments.length<=0||void 0===arguments[0]?f:arguments[0];switch(d.includes(e)||(console.error(`Bad users route: "${e}". Falling back to ${f}.`),e=f),e){case"login":this.login();break;case"logout":this.logout()}},i.prototype.login=function(){t.render(e.createElement(g,{server:this.server}),this.mountNode)},i.prototype.logout=function(){this.server.logout().then(function(){location.hash="users/login"})},i}(p),y=["red","orange","green","blue","violet"],v=function(e){function t(n){a(this,t);var i=u(this,e.call(this,n));return i.reminder=n.reminder,i}return l(t,e),t.prototype.getColour=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=function(e){var t=0,n=void 0,i=void 0,o=void 0;if(0===e.length)return 0;for(n=0,o=e.length;n<o;n++)i=e.charCodeAt(n),t=(t<<5)-t+i,t|=0;return t};return y[t(e)%y.length]},t.prototype.render=function(){var e=this.reminder,t=["reminders__item-content",this.getColour(e.recipient.join(" "))].join(" and ");return s("li",{className:"reminders__item"},void 0,s("div",{className:"reminders__item-time"},void 0,s("div",{},void 0,i(e.datetime).format("LT"))),s("div",{className:t},void 0,s("h3",{className:"reminders__item-recipient"},void 0,e.recipient),s("p",{className:"reminders__item-text"},void 0,e.content)))},t}(e.Component),b=function(e){function t(n){a(this,t);var o=u(this,e.call(this,n));return o.state={reminders:[]},o.speechController=n.speechController,o.server=n.server,i.locale(navigator.languages||navigator.language||"en-US"),o}return l(t,e),t.prototype.componentDidMount=function(){var e=this;this.server.reminders.getAll().then(function(t){t=t.map(function(e){return{id:e.id,recipient:[e.recipient],content:e.message,datetime:e.due}}),e.setState({reminders:t})}),this.speechController.on("wakelistenstart",function(){console.log("wakelistenstart")}),this.speechController.on("wakelistenstop",function(){console.log("wakelistenstop")}),this.speechController.on("wakeheard",function(){console.log("wakeheard")}),this.speechController.on("speechrecognitionstart",function(){console.log("speechrecognitionstart")}),this.speechController.on("speechrecognitionstop",function(){console.log("speechrecognitionstop")}),this.speechController.on("reminder",function(t){console.log("reminder",t);var n=e.state.reminders;n.push({id:n.length,recipient:t.users,content:t.action,datetime:t.time}),e.setState({reminders:n}),e.server.reminders.set({recipient:t.users.join(" "),message:t.action,due:Number(t.time)}).then(function(e){console.log(e)})["catch"](function(e){console.error(e)})})},t.prototype.render=function(){var e=this.state.reminders;e=e.sort(function(e,t){return e.datetime-t.datetime}),e=n.groupBy(e,function(e){return i(e.datetime).format("YYYY/MM")}),Object.keys(e).forEach(function(t){e[t]=n.groupBy(e[t],function(e){return i(e.datetime).format("YYYY/MM/DD")})});var t=Object.keys(e).map(function(t){var n=i(t,"YYYY/MM").format("MMMM"),o=e[t];return s("div",{},t,s("h2",{className:"reminders__month"},void 0,n),Object.keys(o).map(function(e){var t=i(e,"YYYY/MM/DD"),n=o[e];return s("div",{className:"reminders__day"},e,s("div",{className:"reminders__day-date"},void 0,s("div",{className:"reminders__day-mday"},void 0,t.format("DD")),s("div",{className:"reminders__day-wday"},void 0,t.format("ddd"))),s("ol",{className:"reminders__list"},void 0,n.map(function(e){return s(v,{reminder:e},e.id)})))}))});return s("section",{className:"reminders"},void 0,t)},t}(e.Component),w=function(n){function i(){return a(this,i),u(this,n.apply(this,arguments))}return l(i,n),i.prototype.main=function(){t.render(e.createElement(b,{speechController:this.speechController,server:this.server}),this.mountNode)},i}(p),S=function(e){if(!e||"string"!=typeof e)throw new Error("Event name should be a valid non-empty string!")},k=function(e){if("function"!=typeof e)throw new Error("Handler should be a function!")},E=function(e,t){if(e&&e.indexOf(t)<0)throw new Error(`Event "${t}" is not allowed!`)},O=Object.freeze({allowedEvents:Symbol("allowedEvents"),listeners:Symbol("listeners")}),R=function(){function e(t){if(a(this,e),"undefined"!=typeof t&&!Array.isArray(t))throw new Error("Allowed events should be a valid array of strings!");this[O.listeners]=new Map,this[O.allowedEvents]=t}return e.prototype.on=function(e,t){S(e),E(this[O.allowedEvents],e),k(t);var n=this[O.listeners].get(e);n||(n=new Set,this[O.listeners].set(e,n)),n.add(t)},e.prototype.once=function t(e,n){var i=this;k(n);var t=function(o){i.off(e,t),n.call(i,o)};this.on(e,t)},e.prototype.off=function(e,t){S(e),E(this[O.allowedEvents],e),k(t);var n=this[O.listeners].get(e);n&&(n["delete"](t),n.size||this[O.listeners]["delete"](e))},e.prototype.offAll=function(e){if("undefined"==typeof e)return void this[O.listeners].clear();S(e),E(this[O.allowedEvents],e);var t=this[O.listeners].get(e);t&&(t.clear(),this[O.listeners]["delete"](e))},e.prototype.emit=function(e,t){var n=this;S(e),E(this[O.allowedEvents],e);var i=this[O.listeners].get(e);i&&i.forEach(function(e){try{e.call(n,t)}catch(i){console.error(i)}})},e.prototype.hasListeners=function(e){return S(e),E(this[O.allowedEvents],e),this[O.listeners].has(e)},e}(),C=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];a(this,e);var n=t.minimumConfidence||.35,i=t.bufferCount||80,r=t.maxVoiceActivityGap||300,s=t.numGroups||60,c=t.groupSize||5;this.recogniser=new o,this.recogniser.keywordSpottingMinimumConfidence=n,this.recogniser.keywordSpottingBufferCount=i,this.recogniser.keywordSpottingMaxVoiceActivityGap=r,this.recogniser.numGroups=s,this.recogniser.groupSize=c,Object.seal(this)}return e.prototype.startListening=function(){var e=this;return new Promise(function(t){e.recogniser.openMic(),e.recogniser.isRecording()||e.recogniser.startKeywordSpottingRecording(),t()})},e.prototype.stopListening=function(){var e=this;return new Promise(function(t){e.recogniser.isRecording()&&e.recogniser.stopRecording(),t()})},e.prototype.loadModel=function(e){if(this.recogniser.isRecording())throw new Error("Load the model data before listening for wakeword");this.recogniser.model=e},e.prototype.setOnKeywordSpottedCallback=function(e){this.recogniser.keywordSpottedCallback=e},e}(),P=Object.freeze({isListening:Symbol("isListening"),recognition:Symbol("recognition"),supportsRecognition:Symbol("supportsRecognition")}),L=function(){function e(){a(this,e),this[P.isListening]=!1;var t=window.SpeechRecognition||window.webkitSpeechRecognition,n=!!t;this[P.supportsRecognition]=n,n?this[P.recognition]=new t:this[P.recognition]=null,Object.seal(this)}return e.prototype.listenForUtterance=function(){var e=this;return this[P.supportsRecognition]?new Promise(function(t,n){return e[P.isListening]?n(new Error("Speech recognition is already listening")):(e[P.isListening]=!0,e[P.recognition].onresult=function(n){e[P.recognition].stop(),e[P.isListening]=!1;var i=n.results[0][0];return t({confidence:i.confidence,utterance:i.transcript})},e[P.recognition].onerror=function(t){return e[P.recognition].stop(),e[P.isListening]=!1,n(t)},void e[P.recognition].start())}):Promise.reject(new Error("Speech recognition not supported in this browser"))},e.prototype.abort=function(){return this[P.recognition].abort(),this[P.isListening]=!1,Promise.resolve()},e}(),j=Object.freeze({regexps:Symbol("regexps"),parseUsers:Symbol("parseUsers"),parseAction:Symbol("parseAction"),parseDatetime:Symbol("parseDatetime"),normalise:Symbol("normalise"),init:Symbol("init"),buildRegExp:Symbol("buildRegExp"),splitOnPlaceholders:Symbol("splitOnPlaceholders"),escape:Symbol("escape")}),_={en:{patterns:[`Remind [user] to [action] at [time].`,`Remind [user] to [action] on [time].`,`Remind [user] to [action] by [time].`,`Remind [user] at [time] to [action].`,`Remind [user] on [time] to [action].`,`Remind [user] by [time] to [action].`,`Remind [user] that it is [action] on [time].`,`Remind [user] that [time] is [action].`],placeholders:{user:"( \\S+ | \\S+,? and \\S+ )",action:"(.+)",time:"(.+)"},punctuation:new RegExp(`[-‐–—,;:!?.…'‘’"“”()\\[\\]§@*/&#†‡′″]+$`,"u")},fr:{patterns:[`Rappelle [user] de [action] [time].`,`Rappelle [user] d'[action] [time].`,`Rappelle-[user] de [action] [time].`,`Rappelle-[user] d'[action] [time].`],placeholders:{user:"( \\S+ | \\S+ et \\S+ )",action:"(.+)",time:"(.+)"},punctuation:new RegExp(`[-‐–—,;:!?.…’"“”«»()\\[\\]§@*/&#†‡]+$`,"u")},ja:{patterns:[`[time][action]を[user]に思い出させて。`,`[time][user]に[action]を思い出させて。`,`[time][user]は[action]と言うリマインダーを作成して。`],placeholders:{user:"(\\S+|\\S+と\\S+)",action:"(.+)",time:"(.+)"},punctuation:new RegExp(`[-‾_＿－‐—―〜・･,，、､;；:：!！?？.．‥…。｡＇‘’"＂“”(（)）\\[［\\]］{｛}｝`+`〈〉《》「｢」｣『』【】〔〕‖§¶@＠*＊/／\＼&＆#＃%％‰†‡′″〃※]+$`,"u")}},U=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?"en":arguments[0];a(this,e),this.locale=t,this[j.regexps]={},this[j.init](),Object.seal(this)}return e.prototype.parse=function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return t?new Promise(function(n,i){var o=e[j.regexps][e.locale].some(function(o){if(!o.patterns.test(t))return!1;var r=o.patterns.exec(t);r.shift();var s=e[j.parseUsers](r[o.placeholders.user]),a=e[j.parseAction](r[o.placeholders.action]),c=e[j.parseDatetime](r[o.placeholders.time]);return null===c?(i("Time could not be parsed."),!1):(n({users:s,action:a,time:c}),!0)});if(!o)return i("Unsupported intent format.")}):Promise.reject("Empty string.")},e.prototype[j.parseUsers]=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return[e.trim()]},e.prototype[j.parseAction]=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return e.trim()},e.prototype[j.parseDatetime]=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];e=e.trim();var t=r.parseDate(e);return t},e.prototype[j.normalise]=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=arguments.length<=1||void 0===arguments[1]?this.locale:arguments[1];return e.replace(/\s+/g," ").trim().replace(_[t].punctuation,"")},e.prototype[j.init]=function(){var e=this;Object.keys(_).forEach(function(t){e[j.regexps][t]=_[t].patterns.map(function(n){return e[j.buildRegExp](t,n,_[t].placeholders)})}),console.log(this[j.regexps])},e.prototype[j.buildRegExp]=function(){var e=arguments.length<=0||void 0===arguments[0]?"en":arguments[0],t=this,n=arguments.length<=1||void 0===arguments[1]?"":arguments[1],i=arguments[2];n=this[j.normalise](n,e);var o=this[j.splitOnPlaceholders](n),r={},s=0,a=o.map(function(e){if(e.startsWith("[")){var n=e.substr(1).replace(new RegExp("\\]$","u"),"");return r[n]=s,s++,i[n]}return" "===e?"\\b \\b":t[j.escape](e).replace(new RegExp("^ ","u"),"\\b").replace(new RegExp(" $","u"),"\\b")});return a=new RegExp(`^${a.join("")}$`,"iu"),{patterns:a,placeholders:r}},e.prototype[j.splitOnPlaceholders]=function(e){var t=[""],n=0;return e.split("").forEach(function(e){"["===e&&""!==t[n]&&(n++,t[n]=""),t[n]+=e,"]"===e&&(n++,t[n]="")}),t},e.prototype[j.escape]=function(e){return e.replace(new RegExp("\\.","gu"),"\\.").replace(new RegExp("\\/","gu"),"\\/").replace(new RegExp("\\(","gu"),"\\(").replace(new RegExp("\\)","gu"),"\\)")},e}(),N=Object.freeze({wakewordRecogniser:Symbol("wakewordRecogniser"),wakewordModelUrl:Symbol("wakewordModelUrl"),speechRecogniser:Symbol("speechRecogniser"),initialiseSpeechRecognition:Symbol("initialiseSpeechRecognition"),startListeningForWakeword:Symbol("startListeningForWakeword"),stopListeningForWakeword:Symbol("stopListeningForWakeword"),listenForUtterance:Symbol("listenForUtterance"),handleSpeechRecognitionEnd:Symbol("handleSpeechRecognitionEnd"),intentParser:Symbol("intentParser")}),T=["wakelistenstart","wakelistenstop","wakeheard","speechrecognitionstart","speechrecognitionstop","reminder"],A=function(e){function t(){a(this,t);var n=u(this,e.call(this,T)),i=new C,o=new L;return n[N.intentParser]=new U,i.setOnKeywordSpottedCallback(function(){n.emit(T[2]),n.startSpeechRecognition()}),n[N.wakewordRecogniser]=i,n[N.wakewordModelUrl]="data/wakeword_model.json",n[N.speechRecogniser]=o,Object.seal(n),n}return l(t,e),t.prototype.start=function(){return this[N.initialiseSpeechRecognition]().then(this[N.startListeningForWakeword].bind(this))},t.prototype.startSpeechRecognition=function(){return this[N.stopListeningForWakeword]().then(this[N.listenForUtterance].bind(this)).then(this[N.handleSpeechRecognitionEnd].bind(this)).then(this[N.startListeningForWakeword].bind(this))["catch"](this[N.startListeningForWakeword].bind(this))},t.prototype.stopSpeechRecognition=function(){return this[N.speechRecogniser].abort().then(this[N.startListeningForWakeword].bind(this))},t.prototype[N.initialiseSpeechRecognition]=function(){var e=this;return fetch(this[N.wakewordModelUrl]).then(function(e){return e.json()}).then(function(t){e[N.wakewordRecogniser].loadModel(t)})},t.prototype[N.startListeningForWakeword]=function(){return this.emit(T[0]),this[N.wakewordRecogniser].startListening()},t.prototype[N.stopListeningForWakeword]=function(){return this.emit(T[1]),this[N.wakewordRecogniser].stopListening()},t.prototype[N.listenForUtterance]=function(){return this.emit(T[3]),this[N.speechRecogniser].listenForUtterance()},t.prototype[N.handleSpeechRecognitionEnd]=function(e){var t=this;this.emit(T[4],e),this[N.intentParser].parse(e.utterance).then(function(e){t.emit(T[5],e)})},t}(R),x="cue-",M="https://calendar.knilxof.org",F=1,z=/([A-Z])/g,D=Object.freeze({values:Symbol("values"),storage:Symbol("storage"),updateSetting:Symbol("updateSetting"),stringToSettingTypedValue:Symbol("stringToSettingTypedValue"),getDefaultSettingValue:Symbol("getDefaultSettingValue"),onStorage:Symbol("onStorage")}),V=Object.freeze({SESSION:Object.freeze({key:"session"}),PUSH_ENDPOINT:Object.freeze({key:"pushEndpoint"}),PUSH_PUB_KEY:Object.freeze({key:"pushPubKey"}),PUSH_AUTH:Object.freeze({key:"pushAuth"})}),Y=function(e){function t(){var n=arguments.length<=0||void 0===arguments[0]?localStorage:arguments[0];a(this,t);var i=u(this,e.call(this));return i[D.storage]=n||{getItem:function(){return null},setItem:function(){},removeItem:function(){},clear:function(){}},i[D.values]=new Map,Object.keys(V).forEach(function(e){var t=V[e],n=i[D.storage].getItem(`${x}${t.key}`);i[D.values].set(t,i[D.stringToSettingTypedValue](t,n))}),window.addEventListener("storage",i[D.onStorage].bind(i)),Object.seal(i),i}return l(t,e),t.prototype.clear=function(){var e=this;return new Promise(function(t){Object.keys(V).forEach(function(t){var n=V[t];e[D.updateSetting](n,e[D.getDefaultSettingValue](n))}),t()})},t.prototype[D.updateSetting]=function(e,t){var n=this[D.values].get(e);n!==t&&(this[D.values].set(e,t),t!==this[D.getDefaultSettingValue](e)?this[D.storage].setItem(`${x}${e.key}`,t):this[D.storage].removeItem(`${x}${e.key}`),this.emit(e.key.replace(z,function(e){return`-${e.toLowerCase()}`}),t))},t.prototype[D.stringToSettingTypedValue]=function(e,t){return null===t?this[D.getDefaultSettingValue](e):"boolean"===e.type?"true"===t:"number"===e.type?Number(t):t},t.prototype[D.getDefaultSettingValue]=function(e){return void 0!==e.defaultValue?e.defaultValue:"boolean"!==e.type&&("number"===e.type?0:null)},t.prototype[D.onStorage]=function(e){if(e.key.startsWith(x)){var t=e.key.substring(x.length),n=Object.keys(V).find(function(e){return V[e].key===t});if(!n)return void console.warn(`Changed unknown storage entry with app specific prefix: ${e.key}`);var i=V[n];this[D.updateSetting](i,this[D.stringToSettingTypedValue](i,e.newValue))}},c(t,[{key:"session",get:function(){return this[D.values].get(V.SESSION)},set:function(e){this[D.updateSetting](V.SESSION,e)}},{key:"origin",get:function(){return M}},{key:"apiVersion",get:function(){return F}},{key:"pushEndpoint",get:function(){return this[D.values].get(V.PUSH_ENDPOINT)},set:function(e){this[D.updateSetting](V.PUSH_ENDPOINT,e)}},{key:"pushPubKey",get:function(){return this[D.values].get(V.PUSH_PUB_KEY)},set:function(e){this[D.updateSetting](V.PUSH_PUB_KEY,e)}},{key:"pushAuth",get:function(){return this[D.values].get(V.PUSH_AUTH)},set:function(e){this[D.updateSetting](V.PUSH_AUTH,e)}}]),t}(R),W=Object.freeze({settings:Symbol("settings"),online:Symbol("online"),init:Symbol("init"),fetch:Symbol("fetch")}),H=function(e){function t(n){a(this,t);var i=u(this,e.call(this,["online"]));return i[W.settings]=n,i[W.online]=!1,Object.seal(i),i[W.init](),i}return l(t,e),t.prototype[W.init]=function(){var e=this;this[W.online]=navigator.onLine,window.addEventListener("online",function(t){e[W.online]=t,e.emit("online",t)}),window.addEventListener("offline",function(t){e[W.online]=t,e.emit("online",t)}),"connection"in navigator&&"onchange"in navigator.connection&&navigator.connection.addEventListener("change",function(){var t=navigator.onLine;e[W.online]=t,e.emit("online",t)})},t.prototype.fetchJSON=function(e){var t=arguments.length<=1||void 0===arguments[1]?"GET":arguments[1],n=arguments.length<=2||void 0===arguments[2]?void 0:arguments[2];return this[W.fetch](e,"application/json",t,n).then(function(e){return e.json()})},t.prototype.fetchBlob=function(e,t,n,i){return this[W.fetch](e,t,n,i).then(function(e){return e.blob()})},t.prototype[W.fetch]=function(e,t){var n=arguments.length<=2||void 0===arguments[2]?"GET":arguments[2],i=arguments.length<=3||void 0===arguments[3]?void 0:arguments[3];n=n.toUpperCase();var o={method:n,headers:{Accept:t},cache:"no-store"};return"POST"!==n&&"PUT"!==n&&"DELETE"!==n||(o.headers["Content-Type"]="application/json;charset=UTF-8"),this[W.settings].session&&(o.headers.Authorization=`Bearer ${this[W.settings].session}`),void 0!==i&&(o.body=JSON.stringify(i)),fetch(e,o).then(function(e){if(!e.ok)throw new TypeError(`The response returned a ${e.status} HTTP status code.`);return e})["catch"](function(e){throw console.error("Error occurred while fetching content: ",e),e})},c(t,[{key:"origin",get:function(){return this[W.settings].origin}},{key:"online",get:function(){return this[W.online]}}]),t}(R),I=Object.freeze({api:Symbol("api"),settings:Symbol("settings"),listenForMessages:Symbol("listenForMessages")}),K=function(e){function t(n,i){a(this,t);var o=u(this,e.call(this,["message"]));return o[I.api]=n,o[I.settings]=i,Object.seal(o),o}return l(t,e),t.prototype.subscribeToNotifications=function(){var e=this,t=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];if(!navigator.serviceWorker)return Promise.reject("No service worker supported");navigator.serviceWorker.addEventListener("message",this[I.listenForMessages].bind(this));var n=this[I.settings];return n.pushEndpoint&&n.pushPubKey&&n.pushAuth&&!t?Promise.resolve():navigator.serviceWorker.ready.then(function(e){return e.pushManager.subscribe({userVisibleOnly:!0})}).then(function(t){var i=t.endpoint,o=t.getKey?t.getKey("p256dh"):"",r=t.getKey?t.getKey("auth"):"";n.pushEndpoint=i,n.pushPubKey=btoa(String.fromCharCode.apply(null,new Uint8Array(o))),n.pushAuth=btoa(String.fromCharCode.apply(null,new Uint8Array(r)));var s=[[[{id:"channel:subscribe.webpush@link.mozilla.org"}],{subscriptions:[{public_key:n.pushPubKey,push_uri:n.pushEndpoint,auth:n.pushAuth}]}]];return e[I.api].put("channels/set",s)}).then(function(){var t=[[[{id:"channel:resource.webpush@link.mozilla.org"}],{resources:["res1"]}]];return e[I.api].put("channels/set",t)})["catch"](function(e){if("denied"===Notification.permission)throw new Error("Permission request was denied.");throw console.error("Error while saving subscription ",e),new Error(`Subscription error: ${e}`)})},t.prototype[I.listenForMessages]=function(e){var t=e.data||{};t.action&&this.emit("message",t)},t}(R),B=Object.freeze({settings:Symbol("settings"),net:Symbol("net"),getURL:Symbol("getURL"),onceOnline:Symbol("onceOnline"),onceReady:Symbol("onceReady"),getChannelValues:Symbol("getChannelValues"),updateChannelValue:Symbol("updateChannelValue")}),J=function(){function e(t,n){a(this,e),this[B.net]=t,this[B.settings]=n,Object.freeze(this)}return e.prototype.get=function(e){var t=this;return this[B.onceReady]().then(function(){return t[B.net].fetchJSON(t[B.getURL](e))})},e.prototype.post=function(e,t){var n=this;return console.log(e,t),this[B.onceReady]().then(function(){return n[B.net].fetchJSON(n[B.getURL](e),"POST",t)})},e.prototype.put=function(e,t){var n=this;return this[B.onceReady]().then(function(){return n[B.net].fetchJSON(n[B.getURL](e),"PUT",t)})},e.prototype["delete"]=function(e,t){var n=this;return this[B.onceReady]().then(function(){return n[B.net].fetchJSON(n[B.getURL](e),"DELETE",t)})},e.prototype.blob=function(e,t){var n=this,i=arguments.length<=2||void 0===arguments[2]?"image/jpeg":arguments[2];return this[B.onceReady]().then(function(){return t?n[B.net].fetchBlob(n[B.getURL](e),i,"PUT",t):n[B.net].fetchBlob(n[B.getURL](e),i)})},e.prototype[B.getURL]=function(e){if(!e||"string"!=typeof e)throw new Error("Path should be a valid non-empty string.");return`${this[B.net].origin}/api/v${this[B.settings].apiVersion}/${e}`},e.prototype[B.onceReady]=function(){return Promise.all([this[B.onceOnline]()])},e.prototype[B.onceOnline]=function(){var e=this[B.net];return e.online?Promise.resolve():new Promise(function(t){return e.once("online",function(){return t()})})},e}(),G=Object.freeze({api:Symbol("api"),settings:Symbol("settings")}),$=function(){function e(t,n){a(this,e),this[G.api]=t,this[G.settings]=n,Object.seal(this)}return e.prototype.getAll=function(){return this[G.api].get("reminders")},e.prototype.get=function(e){return this[G.api].get(`reminders/${e}`)},e.prototype.set=function(e){return this[G.api].post(`reminders`,e)},e}(),q=Object.freeze({settings:Symbol("settings"),net:Symbol("net"),webPush:Symbol("webPush"),api:Symbol("api")}),Z=function(e){function t(){var n=arguments.length<=0||void 0===arguments[0]?{}:arguments[0],i=n.settings,o=n.net;a(this,t);var r=u(this,e.call(this,["online"]));return r[q.settings]=i||new Y,r[q.net]=o||new H(r[q.settings]),r[q.api]=new J(r[q.net],r[q.settings]),r[q.webPush]=new K(r[q.api],r[q.settings]),r.reminders=new $(r[q.api],r[q.settings]),r[q.net].on("online",function(e){return r.emit("online",e)}),r[q.webPush].on("message",function(e){return r.emit("push-message",e)}),window.server=r,Object.seal(r),r}return l(t,e),t.prototype.clear=function(){var e=arguments.length<=0||void 0===arguments[0]||arguments[0],t=[this[q.settings].clear()];return navigator.serviceWorker||e||t.push(navigator.serviceWorker.ready.then(function(e){return e.unregister()})),Promise.all(t)},t.prototype.login=function(e,t){var n=this;return this[q.api].post("login",{user:e,password:t}).then(function(e){n[q.settings].session=e.token})},t.prototype.logout=function(){return this[q.settings].session=null,Promise.resolve()},t.prototype.subscribeToNotifications=function(){var e=!(arguments.length<=0||void 0===arguments[0])&&arguments[0];return this[q.webPush].subscribeToNotifications(e)},c(t,[{key:"online",get:function(){return this[q.net].online}},{key:"isLoggedIn",get:function(){return!!this[q.settings].session}}]),t}(R),Q=function(e){function t(n){a(this,t);var i=u(this,e.call(this,n));return i.state={isListening:!1},i.speechController=n.speechController,i.server=n.server,i.bleep=new Audio,i.bleep.src="media/cue.wav",i.speechController.on("wakeheard",function(){i.bleep.pause(),i.bleep.currentTime=0,i.bleep.play(),i.setState({isListening:!0})}),i.speechController.on("speechrecognitionstop",function(){i.setState({isListening:!1})}),i.click=i.click.bind(i),i}return l(t,e),t.prototype.shouldComponentUpdate=function(e,t){return!!this.server.isLoggedIn&&JSON.stringify(this.state)!==JSON.stringify(t)},t.prototype.click=function(){return this.state.isListening?(this.setState({isListening:!1}),void this.speechController.stopSpeechRecognition()):(this.bleep.pause(),this.bleep.currentTime=0,this.bleep.play(),this.setState({isListening:!0}),void this.speechController.startSpeechRecognition())},t.prototype.render=function(){if(!this.server.isLoggedIn)return null;var e=this.state.isListening?"listening":"";return s("div",{className:e,onClick:this.click},void 0,s("div",{className:"microphone__background"}),s("img",{className:"microphone__icon",src:"css/icons/microphone.svg"}))},t}(e.Component),X=Object.freeze({controllers:Symbol("controllers"),speechController:Symbol("speechController"),server:Symbol("server"),onHashChanged:Symbol("onHashChanged")}),ee=function(n){function i(){a(this,i);var e=u(this,n.call(this)),t=document.querySelector(".app-view-container"),o=new A,r=new Z,s={mountNode:t,speechController:o,server:r},c=new m(s),l=new w(s);return e[X.controllers]={"":c,"users/(.+)":c,reminders:l},e[X.speechController]=o,e[X.server]=r,window.addEventListener("hashchange",e[X.onHashChanged].bind(e)),e}return l(i,n),i.prototype.main=function(){var n=this;screen&&"orientation"in screen&&"lock"in screen.orientation&&screen.orientation.lock("landscape")["catch"](function(e){console.error(e)}),this[X.speechController].start().then(function(){console.log("Speech controller started")}),location.hash="",setTimeout(function(){n[X.server].isLoggedIn?location.hash="reminders":location.hash="users/login"}),t.render(e.createElement(Q,{speechController:this[X.speechController],server:this[X.server]}),document.querySelector(".microphone"))},i.prototype[X.onHashChanged]=function(){var e=window.location.hash.slice(1);for(var t of Object.keys(this[X.controllers])){var n=e.match(new RegExp(`^${t}$`));if(n){var i;(i=this[X.controllers][t]).main.apply(i,h(n.slice(1)));break}}},i}(p),te=new ee;te.main()});
//# sourceMappingURL=app.js.map
