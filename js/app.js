define(["components/react","components/react-dom","components/lodash","components/moment","components/jsspeechrecognizer","components/chrono"],function(e,t,n,o,i,r){"use strict";e="default"in e?e["default"]:e,t="default"in t?t["default"]:t,n="default"in n?n["default"]:n,o="default"in o?o["default"]:o,i="default"in i?i["default"]:i,r="default"in r?r["default"]:r;var s=function(){var e="function"==typeof Symbol&&Symbol["for"]&&Symbol["for"]("react.element")||60103;return function(t,n,o,i){var r=t&&t.defaultProps,s=arguments.length-3;if(n||0===s||(n={}),n&&r)for(var c in r)void 0===n[c]&&(n[c]=r[c]);else n||(n=r||{});if(1===s)n.children=i;else if(s>1){for(var a=Array(s),l=0;l<s;l++)a[l]=arguments[l+3];n.children=a}return{$$typeof:e,type:t,key:void 0===o?null:""+o,ref:null,props:n,_owner:null}}}(),c=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},a=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},l=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},p=function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)},u=function(){function e(t){c(this,e),Object.assign(this,t||{})}return e.prototype.main=function(){throw new Error("Not implemented!")},e}(),h=function(e){function t(){return c(this,t),l(this,e.apply(this,arguments))}return a(t,e),t.prototype.render=function(){return s("form",{className:"user-login"},void 0,s("input",{placeholder:"Family name",className:"user-login__name-field"}),s("button",{className:"user-login__login-button"},void 0,s("img",{src:"css/icons/next.svg"})))},t}(e.Component),d=["login","logout"],f=d[0],g=function(n){function o(){return c(this,o),l(this,n.apply(this,arguments))}return a(o,n),o.prototype.main=function(){var e=arguments.length<=0||void 0===arguments[0]?f:arguments[0];switch(d.includes(e)||(console.error(`Bad users route: "${e}". Falling back to ${f}.`),e=f),e){case"login":this.login();break;case"logout":this.logout()}},o.prototype.login=function(){t.render(e.createElement(h,{}),this.mountNode)},o.prototype.logout=function(){location.hash="#users/login"},o}(u),m=["red","orange","green","blue","violet"],y=function(e){function t(n){c(this,t);var o=l(this,e.call(this,n));return o.reminder=n.reminder,o}return a(t,e),t.prototype.getColour=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=function(e){var t=0,n=void 0,o=void 0,i=void 0;if(0===e.length)return 0;for(n=0,i=e.length;n<i;n++)o=e.charCodeAt(n),t=(t<<5)-t+o,t|=0;return t};return m[t(e)%m.length]},t.prototype.render=function(){var e=this.reminder,t=["reminders__item-content",this.getColour(e.recipient.join(" "))].join(" and ");return s("li",{className:"reminders__item"},void 0,s("div",{className:"reminders__item-time"},void 0,s("div",{},void 0,o(e.datetime).format("LT"))),s("div",{className:t},void 0,s("h3",{className:"reminders__item-recipient"},void 0,e.recipient),s("p",{className:"reminders__item-text"},void 0,e.content)))},t}(e.Component),w=function(e){function t(n){c(this,t);var i=l(this,e.call(this,n));i.speechController=n.speechController,o.locale(navigator.languages||navigator.language||"en-US");var r=0,s=[{id:r++,recipient:["Guillaume"],content:"Get a haircut",datetime:Date.now()+36e5},{id:r++,recipient:["Guillaume"],content:"File a bug",datetime:Date.now()+9e6},{id:r++,recipient:["Julien"],content:"Do the laundry",datetime:Date.now()+864e5},{id:r++,recipient:["Sam"],content:"Attend ping pong competition",datetime:Date.now()+9072e5},{id:r++,recipient:["Guillaume"],content:"Attend Swan Lake by the Bolshoi Ballet",datetime:Date.now()+3888e6}];return i.state={reminders:s},i.speechController.on("wakelistenstart",function(){console.log("wakelistenstart")}),i.speechController.on("wakelistenstop",function(){console.log("wakelistenstop")}),i.speechController.on("wakeheard",function(){console.log("wakeheard")}),i.speechController.on("speechrecognitionstart",function(){console.log("speechrecognitionstart")}),i.speechController.on("speechrecognitionstop",function(){console.log("speechrecognitionstop")}),i.speechController.on("reminder",function(e){console.log("reminder",e);var t=i.state.reminders;t.push({id:t.length,recipient:e.users,content:e.action,datetime:e.time}),i.setState(t)}),i}return a(t,e),t.prototype.render=function(){var e=this.state.reminders;e=e.sort(function(e,t){return e.datetime-t.datetime}),e=n.groupBy(e,function(e){return o(e.datetime).format("YYYY/MM")}),Object.keys(e).forEach(function(t){e[t]=n.groupBy(e[t],function(e){return o(e.datetime).format("YYYY/MM/DD")})});var t=Object.keys(e).map(function(t){var n=o(t,"YYYY/MM").format("MMMM"),i=e[t];return s("div",{},t,s("h2",{className:"reminders__month"},void 0,n),Object.keys(i).map(function(e){var t=o(e,"YYYY/MM/DD"),n=i[e];return s("div",{className:"reminders__day"},e,s("div",{className:"reminders__day-date"},void 0,s("div",{className:"reminders__day-mday"},void 0,t.format("DD")),s("div",{className:"reminders__day-wday"},void 0,t.format("ddd"))),s("ol",{className:"reminders__list"},void 0,n.map(function(e){return s(y,{reminder:e},e.id)})))}))});return s("section",{className:"reminders"},void 0,t)},t}(e.Component),v=function(n){function o(){return c(this,o),l(this,n.apply(this,arguments))}return a(o,n),o.prototype.main=function(){t.render(e.createElement(w,{speechController:this.speechController}),this.mountNode)},o}(u),b=function(e){if(!e||"string"!=typeof e)throw new Error("Event name should be a valid non-empty string!")},S=function(e){if("function"!=typeof e)throw new Error("Handler should be a function!")},k=function(e,t){if(e&&e.indexOf(t)<0)throw new Error(`Event "${t}" is not allowed!`)},R=Object.freeze({allowedEvents:Symbol("allowedEvents"),listeners:Symbol("listeners")}),E=function(){function e(t){if(c(this,e),"undefined"!=typeof t&&!Array.isArray(t))throw new Error("Allowed events should be a valid array of strings!");this[R.listeners]=new Map,this[R.allowedEvents]=t}return e.prototype.on=function(e,t){b(e),k(this[R.allowedEvents],e),S(t);var n=this[R.listeners].get(e);n||(n=new Set,this[R.listeners].set(e,n)),n.add(t)},e.prototype.once=function t(e,n){var o=this;S(n);var t=function(i){o.off(e,t),n.call(o,i)};this.on(e,t)},e.prototype.off=function(e,t){b(e),k(this[R.allowedEvents],e),S(t);var n=this[R.listeners].get(e);n&&(n["delete"](t),n.size||this[R.listeners]["delete"](e))},e.prototype.offAll=function(e){if("undefined"==typeof e)return void this[R.listeners].clear();b(e),k(this[R.allowedEvents],e);var t=this[R.listeners].get(e);t&&(t.clear(),this[R.listeners]["delete"](e))},e.prototype.emit=function(e,t){var n=this;b(e),k(this[R.allowedEvents],e);var o=this[R.listeners].get(e);o&&o.forEach(function(e){try{e.call(n,t)}catch(o){console.error(o)}})},e.prototype.hasListeners=function(e){return b(e),k(this[R.allowedEvents],e),this[R.listeners].has(e)},e}(),C=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];c(this,e);var n=t.minimumConfidence||.35,o=t.bufferCount||80,r=t.maxVoiceActivityGap||300,s=t.numGroups||60,a=t.groupSize||5;this.recogniser=new i,this.recogniser.keywordSpottingMinimumConfidence=n,this.recogniser.keywordSpottingBufferCount=o,this.recogniser.keywordSpottingMaxVoiceActivityGap=r,this.recogniser.numGroups=s,this.recogniser.groupSize=a,Object.seal(this)}return e.prototype.startListening=function(){var e=this;return new Promise(function(t){e.recogniser.openMic(),e.recogniser.isRecording()||e.recogniser.startKeywordSpottingRecording(),t()})},e.prototype.stopListening=function(){var e=this;return new Promise(function(t){e.recogniser.isRecording()&&e.recogniser.stopRecording(),t()})},e.prototype.loadModel=function(e){if(this.recogniser.isRecording())throw new Error("Load the model data before listening for wakeword");this.recogniser.model=e},e.prototype.setOnKeywordSpottedCallback=function(e){this.recogniser.keywordSpottedCallback=e},e}(),_=Object.freeze({isListening:Symbol("isListening"),recognition:Symbol("recognition"),supportsRecognition:Symbol("supportsRecognition")}),L=function(){function e(){c(this,e),this[_.isListening]=!1;var t=window.SpeechRecognition||window.webkitSpeechRecognition,n=!!t;this[_.supportsRecognition]=n,n?this[_.recognition]=new t:this[_.recognition]=null,Object.seal(this)}return e.prototype.listenForUtterance=function(){var e=this;return this[_.supportsRecognition]?new Promise(function(t,n){return e[_.isListening]?n(new Error("Speech recognition is already listening")):(e[_.isListening]=!0,e[_.recognition].onresult=function(n){e[_.recognition].stop(),e[_.isListening]=!1;var o=n.results[0][0];return t({confidence:o.confidence,utterance:o.transcript})},e[_.recognition].onerror=function(t){return e[_.recognition].stop(),e[_.isListening]=!1,n(t)},void e[_.recognition].start())}):Promise.reject(new Error("Speech recognition not supported in this browser"))},e.prototype.abort=function(){return this[_.recognition].abort(),this[_.isListening]=!1,Promise.resolve()},e}(),x=Object.freeze({regexps:Symbol("regexps"),parseUsers:Symbol("parseUsers"),parseAction:Symbol("parseAction"),parseDatetime:Symbol("parseDatetime"),normalise:Symbol("normalise"),init:Symbol("init"),buildRegExp:Symbol("buildRegExp"),splitOnPlaceholders:Symbol("splitOnPlaceholders"),escape:Symbol("escape")}),j={en:{patterns:[`Remind [user] to [action] at [time].`,`Remind [user] to [action] on [time].`,`Remind [user] to [action] by [time].`,`Remind [user] at [time] to [action].`,`Remind [user] on [time] to [action].`,`Remind [user] by [time] to [action].`,`Remind [user] that it is [action] on [time].`,`Remind [user] that [time] is [action].`],placeholders:{user:"( \\S+ | \\S+,? and \\S+ )",action:"(.+)",time:"(.+)"},punctuation:new RegExp(`[-‐–—,;:!?.…'‘’"“”()\\[\\]§@*/&#†‡′″]+$`,"u")},fr:{patterns:[`Rappelle [user] de [action] [time].`,`Rappelle [user] d'[action] [time].`,`Rappelle-[user] de [action] [time].`,`Rappelle-[user] d'[action] [time].`],placeholders:{user:"( \\S+ | \\S+ et \\S+ )",action:"(.+)",time:"(.+)"},punctuation:new RegExp(`[-‐–—,;:!?.…’"“”«»()\\[\\]§@*/&#†‡]+$`,"u")},ja:{patterns:[`[time][action]を[user]に思い出させて。`,`[time][user]に[action]を思い出させて。`,`[time][user]は[action]と言うリマインダーを作成して。`],placeholders:{user:"(\\S+|\\S+と\\S+)",action:"(.+)",time:"(.+)"},punctuation:new RegExp(`[-‾_＿－‐—―〜・･,，、､;；:：!！?？.．‥…。｡＇‘’"＂“”(（)）\\[［\\]］{｛}｝`+`〈〉《》「｢」｣『』【】〔〕‖§¶@＠*＊/／\＼&＆#＃%％‰†‡′″〃※]+$`,"u")}},O=function(){function e(){var t=arguments.length<=0||void 0===arguments[0]?"en":arguments[0];c(this,e),this.locale=t,this[x.regexps]={},this[x.init](),Object.seal(this)}return e.prototype.parse=function(){var e=this,t=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return t?new Promise(function(n,o){var i=e[x.regexps][e.locale].some(function(i){if(!i.patterns.test(t))return!1;var r=i.patterns.exec(t);r.shift();var s=e[x.parseUsers](r[i.placeholders.user]),c=e[x.parseAction](r[i.placeholders.action]),a=e[x.parseDatetime](r[i.placeholders.time]);return null===a?(o("Time could not be parsed."),!1):(n({users:s,action:c,time:a}),!0)});if(!i)return o("Unsupported intent format.")}):Promise.reject("Empty string.")},e.prototype[x.parseUsers]=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return[e.trim()]},e.prototype[x.parseAction]=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];return e.trim()},e.prototype[x.parseDatetime]=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0];e=e.trim();var t=r.parseDate(e);return t},e.prototype[x.normalise]=function(){var e=arguments.length<=0||void 0===arguments[0]?"":arguments[0],t=arguments.length<=1||void 0===arguments[1]?this.locale:arguments[1];return e.replace(/\s+/g," ").trim().replace(j[t].punctuation,"")},e.prototype[x.init]=function(){var e=this;Object.keys(j).forEach(function(t){e[x.regexps][t]=j[t].patterns.map(function(n){return e[x.buildRegExp](t,n,j[t].placeholders)})}),console.log(this[x.regexps])},e.prototype[x.buildRegExp]=function(){var e=arguments.length<=0||void 0===arguments[0]?"en":arguments[0],t=this,n=arguments.length<=1||void 0===arguments[1]?"":arguments[1],o=arguments[2];n=this[x.normalise](n,e);var i=this[x.splitOnPlaceholders](n),r={},s=0,c=i.map(function(e){if(e.startsWith("[")){var n=e.substr(1).replace(new RegExp("\\]$","u"),"");return r[n]=s,s++,o[n]}return" "===e?"\\b \\b":t[x.escape](e).replace(new RegExp("^ ","u"),"\\b").replace(new RegExp(" $","u"),"\\b")});return c=new RegExp(`^${c.join("")}$`,"iu"),{patterns:c,placeholders:r}},e.prototype[x.splitOnPlaceholders]=function(e){var t=[""],n=0;return e.split("").forEach(function(e){"["===e&&""!==t[n]&&(n++,t[n]=""),t[n]+=e,"]"===e&&(n++,t[n]="")}),t},e.prototype[x.escape]=function(e){return e.replace(new RegExp("\\.","gu"),"\\.").replace(new RegExp("\\/","gu"),"\\/").replace(new RegExp("\\(","gu"),"\\(").replace(new RegExp("\\)","gu"),"\\)")},e}(),M=Object.freeze({wakewordRecogniser:Symbol("wakewordRecogniser"),wakewordModelUrl:Symbol("wakewordModelUrl"),speechRecogniser:Symbol("speechRecogniser"),initialiseSpeechRecognition:Symbol("initialiseSpeechRecognition"),startListeningForWakeword:Symbol("startListeningForWakeword"),stopListeningForWakeword:Symbol("stopListeningForWakeword"),listenForUtterance:Symbol("listenForUtterance"),handleSpeechRecognitionEnd:Symbol("handleSpeechRecognitionEnd"),intentParser:Symbol("intentParser")}),N=["wakelistenstart","wakelistenstop","wakeheard","speechrecognitionstart","speechrecognitionstop","reminder"],A=function(e){function t(){c(this,t);var n=l(this,e.call(this,N)),o=new C,i=new L;return n[M.intentParser]=new O,o.setOnKeywordSpottedCallback(function(){n.emit(N[2]),n.startSpeechRecognition()}),n[M.wakewordRecogniser]=o,n[M.wakewordModelUrl]="/data/wakeword_model.json",n[M.speechRecogniser]=i,Object.seal(n),n}return a(t,e),t.prototype.start=function(){return this[M.initialiseSpeechRecognition]().then(this[M.startListeningForWakeword].bind(this))},t.prototype.startSpeechRecognition=function(){return this[M.stopListeningForWakeword]().then(this[M.listenForUtterance].bind(this)).then(this[M.handleSpeechRecognitionEnd].bind(this)).then(this[M.startListeningForWakeword].bind(this))["catch"](this[M.startListeningForWakeword].bind(this))},t.prototype.stopSpeechRecognition=function(){return this[M.speechRecogniser].abort().then(this[M.startListeningForWakeword].bind(this))},t.prototype[M.initialiseSpeechRecognition]=function(){var e=this;return fetch(this[M.wakewordModelUrl]).then(function(e){return e.json()}).then(function(t){e[M.wakewordRecogniser].loadModel(t)})},t.prototype[M.startListeningForWakeword]=function(){return this.emit(N[0]),this[M.wakewordRecogniser].startListening()},t.prototype[M.stopListeningForWakeword]=function(){return this.emit(N[1]),this[M.wakewordRecogniser].stopListening()},t.prototype[M.listenForUtterance]=function(){return this.emit(N[3]),this[M.speechRecogniser].listenForUtterance()},t.prototype[M.handleSpeechRecognitionEnd]=function(e){var t=this;this.emit(N[4],e),this[M.intentParser].parse(e.utterance).then(function(e){t.emit(N[5],e)})},t}(E),F=function(e){function t(n){c(this,t);var o=l(this,e.call(this,n));return o.state={isListening:!1},o.speechController=n.speechController,o.bleep=new Audio,o.bleep.src="../media/cue.wav",o.speechController.on("wakeheard",function(){o.bleep.pause(),o.bleep.currentTime=0,o.bleep.play(),o.setState({isListening:!0})}),o.speechController.on("speechrecognitionstop",function(){o.setState({isListening:!1})}),o.click=o.click.bind(o),o}return a(t,e),t.prototype.click=function(){return this.state.isListening?(this.setState({isListening:!1}),void this.speechController.stopSpeechRecognition()):(this.bleep.pause(),this.bleep.currentTime=0,this.bleep.play(),this.setState({isListening:!0}),void this.speechController.startSpeechRecognition())},t.prototype.render=function(){var e=this.state.isListening?"listening":"";return s("div",{className:e,onClick:this.click},void 0,s("div",{className:"microphone__background"}),s("img",{className:"microphone__icon",src:"../css/icons/microphone.svg"}))},t}(e.Component),P=Object.freeze({controllers:Symbol("controllers"),onHashChanged:Symbol("onHashChanged"),speechController:Symbol("speechController")}),D=function(n){function o(){c(this,o);var e=l(this,n.call(this)),t=document.querySelector(".app-view-container"),i=new A,r={mountNode:t,speechController:i},s=new g(r),a=new v(r);return e[P.controllers]={"":s,"users/(.+)":s,reminders:a},e[P.speechController]=i,window.addEventListener("hashchange",e[P.onHashChanged].bind(e)),e}return a(o,n),o.prototype.main=function(){screen&&"orientation"in screen&&"lock"in screen.orientation&&screen.orientation.lock("landscape")["catch"](function(e){console.error(e)}),this[P.speechController].start().then(function(){console.log("Speech controller started")}),location.hash="",setTimeout(function(){location.hash="reminders"},16),t.render(e.createElement(F,{speechController:this[P.speechController]}),document.querySelector(".microphone"))},o.prototype[P.onHashChanged]=function(){var e=window.location.hash.slice(1);for(var t of Object.keys(this[P.controllers])){var n=e.match(new RegExp(`^${t}$`));if(n){var o;(o=this[P.controllers][t]).main.apply(o,p(n.slice(1)));break}}},o}(u),U=new D;U.main()});
//# sourceMappingURL=app.js.map
